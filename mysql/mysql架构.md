#### mysql的执行流程

![1572963491052](assets\1572963491052.png)



```
大体来说，MySQL 可以分为 Server 层和存储引擎层两部分。

  Server 层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。
	
  而存储引擎层负责数据的存储和提取。其架构模式是插件式的，支持 InnoDB、MyISAM、Memory 等多个存储引擎。现在最常用的存储引擎是 InnoDB，它从 MySQL 5.5.5 版本开始成为了默认存储引擎。
```



```
show processlist;
查看当前数据库连接的状态


wait_timeout
客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数 wait_timeout 控制的，默认值是 8 小时。

 如果你用的是 MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，通过执行
mysql_reset_connection 来重新初始化连接资源。这个过程不需要重连和重新做权限验
证，但是会将连接恢复到刚刚创建完时的状态
```



![1572964469018](assets\1572964469018.png)



![1572964259122](assets\1572964259122.png)



![1572964318410](assets\1572964318410.png)



![1572964438684](assets\1572964438684.png)





#### sql语句的执行流程

```
当有一条记录需要更新的时候，InnoDB 引擎就会先把记录写到 redo log（粉板）

里面，并更新内存，这个时候更新就算完成了。同时，InnoDB 引擎会在适当的时候，将这个操

作记录更新到磁盘里面，而这个更新往往是在系统比较空闲的时候做
```



与此类似，InnoDB 的 redo log 是固定大小的，比如可以配置为一组 4 个文件，每个文件的大
小是 1GB，那么这块“粉板”总共就可以记录 4GB 的操作。从头开始写，写到末尾就又回到开
头循环写，如下面这个图所示。

![1572964859387](assets\1572964859387.png)

wirte pos 是当前记录的位置，一边写一边后移，写到第 3 号文件末尾后就回到 0 号文件开头。
checkpoint 是当前要擦除的位置，也是往后推移并且循环的，擦除记录前要把记录更新到数据
文件。
write pos 和 checkpoint 之间的是“粉板”上还空着的部分，可以用来记录新的操作。如果
write pos 追上 checkpoint，表示“粉板”满了，这时候不能再执行新的更新，得停下来先擦
掉一些记录，把 checkpoint 推进一下。
有了 redo log，InnoDB 就可以保证即使数据库发生异常重启，之前提交的记录都不会丢失，
这个能力称为crash-safe。
要理解 crash-safe 这个概念，可以想想我们前面赊账记录的例子。只要赊账记录记在了粉板上
或写在了账本上，之后即使掌柜忘记了，比如突然停业几天，恢复生意后依然可以通过账本和粉
板上的数据明确赊账账目

