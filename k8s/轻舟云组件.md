









## 轻舟云iptables 配置

```sh
!/bin/bash
# tcp
ipset_tcp_name='skiff-tcp-port-set'
ipset_udp_name='skiff-udp-port-set'
tcp_port_range='0-65535'
udp_port_range='53-123'

skiff_iptables_tcp_ports=('30095 skiff-enhance-exporter' '10254 nginx-ingress-controller' '2380 etcd' '2379 etcd' '80 nginx' '6443 apiserver' '7443 apiserver' '16443 apiserver' '26443 apiserver' '10250 kubelet' '10255 kubelet' '10258 kubelet-scheduler-extender' '6781 mysql' '5678 mysql-inner' '6782 mysql' '1080 mysql' '6789 ceph' '9283 ceph' '8003 ceph' '3306 mysql' '5000 harbor' '29999 harbor' '26381 redis' '26382 redis' '26384 redis' '26385 redis' '26386 redis' '26387 redis' '26388 redis' '26379 redis' '30200 elasticsearch' '9300 elasticsearch' '9200 elasticsearch' '8080 apiserver' '9999 harbor1' '31091 prometheus' '31090 prometheus' '8628 gtxs' '1628 gtxs' '2628 gtxs' '3628 gtxs' '28628 gtxs' '6262 nls-admin' '8899 nsf-meta' '443 user-k8s1' '10260 user-k8s' '10261 user-k8s' '1443 user-k8s' '10262 user-k8s' '44134 user-k8s' '6800-7300 ceph' '12367 demo' '8790 demo' '8973 demo' '30882 gtxs-demo' '7979 seed' '30881 gtxs-demo' '40880 gtxs-demo' '19992 qatest' '1024 mysql-scp' '26383 harbor-redis' '27017 mongodb' '873 harbor-rsync-server1' '874  harbor-rsync-server2' '27383  harbor-redis-haproxy' '53 tcp-dns' '26484 nsf-redis-sentinel' '26500 ncs-nls-sentinel' '26481 apm-redis-sentinel' '26400 ncs-nls-redis' '26482 api-redis-sentinel' '26483 harbor-redis-sentinel' '26485 goapi-redis-sentinel' '26486 nms-redis-sentinel' '26487 uauth-redis-sentinel' '26488 sauth-redis-sentinel' '30090 prometheus' '13444 hpa-custom-adapter' '10252 k8s-controll-manager-exporter' '10251 k8s-scheduler-exporter' '9156 coredns-exporter' '9104 mysql-exporter' '30094 prometheus-healthcheck' '8627 gtxs-server-grpc'    '12580 cicd-jenkins-tunnel' '12581 cicd-jenkins-master' '12582 cicd-web' '12583 cicd-nexus' '12584 cicd-quartz' '12585 cicd-deploy-web' '8980 nsf-server-grpc' '8866 nsf-server-http' '7379 mysql-etcd1' '7380 mysql-etcd2' '6379 nsf-etcd' '6380 nsf-etcd1' '6479 gtxs-etcd' '6480 gtxs-etcd2' '9627 gtxs-grpc' '13811 grpc-demo1' '13890 grpc-demo2' '13889 grpc-demo3' '13886 grpc-demo4' '13887 grpc-demo5'  '12486 grpc-demo6' '12370 grpc-demo7' '12369 grpc-demo8' '13810 grpc-demo9' '12368 grpc-demo10' '2479 event-etcd' '2480 event-etcd-peer'  '12873 cicd-rsync'  '10080 gitlab-web' '10022 gitlab-ssh' '8888 bpms-modeler'  '9997 bpms-task' '9988 bpms-admin' '8080 bpms-idm-rest' '7001 bpms-nuims')

skiff_iptables_udp_ports=('53 udp-dns' '123 ntp')

create_ipset(){
/usr/sbin/ipset -exist create $ipset_tcp_name bitmap:port range $tcp_port_range
/usr/sbin/ipset -exist create $ipset_udp_name bitmap:port range $udp_port_range
}

insert_ipset_port(){
for(( i=0;i<${#skiff_iptables_tcp_ports[@]};i++)) do
    key_val=(${skiff_iptables_tcp_ports[i]})
    key=${key_val[0]}
    val=${key_val[1]}
    /usr/sbin/ipset -exist add $ipset_tcp_name $key
done


for(( i=0;i<${#skiff_iptables_udp_ports[@]};i++)) do
    key_val=(${skiff_iptables_udp_ports[i]})
    key=${key_val[0]}
    val=${key_val[1]}
    /usr/sbin/ipset -exist add $ipset_udp_name $key
done
}

add_iptables(){
# tcp
/sbin/iptables -C INPUT -p tcp -m set --match-set $ipset_tcp_name dst  -m comment --comment "from $ipset_tcp_name " -j ACCEPT >/dev/null 2>&1
if [ $? -ne 0 ]; then
/sbin/iptables -I INPUT -p tcp -m set --match-set $ipset_tcp_name dst  -m comment --comment "from $ipset_tcp_name " -j ACCEPT
fi

/sbin/iptables -C OUTPUT -p tcp -m set --match-set $ipset_tcp_name src  -m comment --comment "from $ipset_tcp_name " -j ACCEPT >/dev/null 2>&1
if [ $? -ne 0 ]; then
/sbin/iptables -I OUTPUT -p tcp -m set --match-set $ipset_tcp_name src  -m comment --comment "from $ipset_tcp_name " -j ACCEPT
fi

# udp

/sbin/iptables -C INPUT -p udp -m set --match-set $ipset_udp_name dst  -m comment --comment "from $ipset_udp_name " -j ACCEPT >/dev/null 2>&1
if [ $? -ne 0 ]; then
/sbin/iptables -I INPUT -p udp -m set --match-set $ipset_udp_name dst  -m comment --comment "from $ipset_udp_name " -j ACCEPT
fi

/sbin/iptables -C OUTPUT -p udp -m set --match-set $ipset_udp_name src  -m comment --comment "from $ipset_udp_name " -j ACCEPT >/dev/null 2>&1
if [ $? -ne 0 ]; then
/sbin/iptables -I OUTPUT -p udp -m set --match-set $ipset_udp_name src  -m comment --comment "from $ipset_udp_name " -j ACCEPT
fi


}
main (){
sleep 5;
create_ipset;
insert_ipset_port;
add_iptables;
}

main;

```

